/*!
 * jQuery Plugin WebCodeCam-1.0.0
 * Author: Tóth András
 * Web: http://atandrastoth.co.uk
 * email: atandrastoth@gmail.com
 * Licensed under the MIT license
 */
(function(n,t,i){"use strict";function b(t,i){this.element=t;l=n(t);this.options=n.extend({},w,i);this._defaults=w;this._name=a;this.init()&&(this.setEventListeners(),(this.options.ReadQRCode||this.options.ReadBarecode)&&this.setCallback())}var r,c,o,l,e,u,s={},f=n('<video style="position:absolute;visibility:hidden;display: none;">')[0],v=!1,y=!1,p=new Worker("../js/DecoderWorker.js"),h=!1,a="WebCodeCam",w={ReadQRCode:!0,ReadBarecode:!0,width:320,height:240,videoSource:{id:!0,maxWidth:640,maxHeight:480},flipVertical:!1,flipHorizontal:!1,zoom:-2,beep:"../js/beep.mp3",brightness:10,autoBrightnessValue:!1,grayScale:!1,contrast:0,threshold:0,sharpness:[],resultFunction:function(){},getUserMediaError:function(){},cameraError:function(){}};b.prototype={init:function(){if(r=this,o=r.element.getContext("2d"),e=r.options.width,u=r.options.height,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia)s[r.options.videoSource.id]&&s[r.options.videoSource.id].active?r.cameraSuccess(s[r.options.videoSource.id]):navigator.getUserMedia({video:{mandatory:{maxWidth:r.options.videoSource.maxWidth,maxHeight:r.options.videoSource.maxHeight},optional:[{sourceId:r.options.videoSource.id}]},audio:!1},r.cameraSuccess,r.cameraError);else return r.options.getUserMediaError(),!1;return!0},cameraSuccess:function(n){s[r.options.videoSource.id]=n;var i=t.URL||t.webkitURL;f.src=i?i.createObjectURL(n):n;f.play()},cameraError:function(n){return r.options.cameraError(n),!1},setEventListeners:function(){f.addEventListener("canplay",function(){y||(f.videoWidth>0&&(u=f.videoHeight/(f.videoWidth/e)),l[0].setAttribute("width",e),l[0].setAttribute("height",u),r.options.flipHorizontal&&(o.scale(-1,1),o.translate(-e,0)),r.options.flipVertical&&(o.scale(1,-1),o.translate(0,-u)),y=!0,(r.options.ReadQRCode||r.options.ReadBarecode)&&r.delay())},!1);f.addEventListener("play",function(){setInterval(function(){var t,n;f.paused||f.ended||(o.clearRect(0,0,e,u),t=r.options.zoom,t<0&&(t=r.optimalZoom()),o.drawImage(f,(e*t-e)/-2,(u*t-u)/-2,e*t,u*t),n=o.getImageData(0,0,e,u),r.options.grayScale&&(n=r.grayScale(n)),(r.options.brightness!=0||r.options.autoBrightnessValue!=!1)&&(n=r.brightness(n,r.options.brightness)),r.options.contrast!=0&&(n=r.contrast(n,r.options.contrast)),r.options.threshold!=0&&(n=r.threshold(n,r.options.threshold)),r.options.sharpness.length!=0&&(n=r.convolute(n,r.options.sharpness)),o.putImageData(n,0,0))},40)},!1)},setCallback:function(){p.onmessage=function(n){h||f.paused||(n.data.success&&n.data.result[0].length>1&&n.data.result[0].indexOf("undefined")==-1?(r.beep(),h=!0,r.delay(),r.options.resultFunction(n.data.result[0],c)):n.data.finished&&(v=!v,setTimeout(function(){r.tryParseBarecode()},320)))};qrcode.callback=function(n){h||f.paused||(r.beep(),h=!0,r.delay(),r.options.resultFunction(n,c))}},tryParseBarecode:function(){var t=v==!0?"flip":"normal",n;c=l[0].toDataURL();n=o.getImageData(0,0,e,u).data;p.postMessage({ImageData:n,Width:e,Height:u,cmd:t,DecodeNr:1,LowLight:!1})},tryParseQRCode:function(){try{c=l[0].toDataURL();qrcode.decode()}catch(n){h||setTimeout(function(){r.tryParseQRCode()},320)}},delay:function(){r.cameraPlay(!0)},cameraStop:function(){h=!0;f.pause()},cameraStopAll:function(){o.clearRect(0,0,e,u);h=!0;f.pause();for(var n in s)s[n]&&(s[n].stop(),s[n]=null)},cameraPlay:function(n){s[r.options.videoSource.id]?n||r.cameraSuccess(s[r.options.videoSource.id]):r.init();h=!0;f.play();setTimeout(function(){h=!1;r.options.ReadBarecode&&r.tryParseBarecode();r.options.ReadQRCode&&r.tryParseQRCode()},2e3)},getLastImageSrc:function(){return c},optimalZoom:function(){return f.videoHeight/u},getImageLightness:function(){for(var c=o.getImageData(0,0,e,u),t=c.data,i=0,r,f,s,h,n=0,l=t.length;n<l;n+=4)r=t[n],f=t[n+1],s=t[n+2],h=Math.floor((r+f+s)/3),i+=h;return Math.floor(i/(e*u))},brightness:function(n,t){var u,i;for(t=t==0&&r.options.autoBrightnessValue!=!1?r.options.autoBrightnessValue-r.getImageLightness():t,u=n.data,i=0;i<u.length;i+=4)u[i]+=t,u[i+1]+=t,u[i+2]+=t;return n},grayScale:function(n){for(var i=n.data,t=0;t<i.length;t+=4){var r=i[t],u=i[t+1],f=i[t+2],e=.2126*r+.7152*u+.0722*f;i[t]=i[t+1]=i[t+2]=e}return n},contrast:function(n,t){for(var t,u,r=n.data,i=0;i<r.length;i+=4)t=10,u=Math.round((r[i]+r[i+1]+r[i+2])/3),u>127?(r[i]+=r[i]/u*t,r[i+1]+=r[i+1]/u*t,r[i+2]+=r[i+2]/u*t):(r[i]-=r[i]/u*t,r[i+1]-=r[i+1]/u*t,r[i+2]-=r[i+2]/u*t);return n},threshold:function(n,t){for(var f,r=n.data,i=0,o=e*u*4;i<o;i+=4)f=r[i]+r[i+1]+r[i+2],r[i]=f<t?r[i+1]=r[i+2]=0:r[i+1]=r[i+2]=255,r[i+3]=255;return n},convolute:function(n,t,r){for(var u,f,e,y,p,o,s,w=n.width,d=n.height,b=w,g=d,h=Math.round(Math.sqrt(t.length)),nt=Math.floor(h/2),c=n.data,ft=i.createElement("canvas"),et=ft.getContext("2d"),tt=et.createImageData(b,g),l=tt.data,ot=r?1:0,a=0;a<g;a++)for(u=0;u<b;u++){var st=a,ht=u,it=0,rt=0,ut=0,k=0,v=(a*b+u)*4;for(f=0;f<h;f++)for(e=0;e<h;e++)y=st+f-nt,p=ht+e-nt,y>=0&&y<d&&p>=0&&p<w&&(o=(y*w+p)*4,s=t[f*h+e],it+=c[o]*s,rt+=c[o+1]*s,ut+=c[o+2]*s,k+=c[o+3]*s);l[v]=it;l[v+1]=rt;l[v+2]=ut;l[v+3]=k+ot*(255-k)}return tt},beep:function(){if(typeof r.options.beep=="string"){var n=r.options.beep;setTimeout(function(){new Audio(n).play()},0)}}};n.fn[a]=function(t){return this.each(function(){n.data(this,"plugin_"+a)||n.data(this,"plugin_"+a,new b(this,t))})}})(jQuery,window,document);
//# sourceMappingURL=WebCodeCam.min.js.map
